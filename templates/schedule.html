{% extends 'base.html' %}

{% block content %}
<div class="max-w-4xl mx-auto mt-8">
    <h1 class="text-4xl font-bold gradient-text mb-8">Table Schedule</h1>

    <!-- Dynamic centered layout for tables -->
    <div id="schedule-container" class="flex flex-wrap justify-center gap-6">
        {% for table in tables %}
        <div class="glass-card p-6 rounded-2xl max-w-2xl w-full">
            <div class="flex justify-between items-center border-b border-slate-700 pb-4 mb-4">
                <h3 class="text-xl font-bold">{{ table['name'] }}</h3>
                <span
                    class="px-3 py-1 rounded-full text-xs font-bold {{ 'bg-red-500/20 text-red-400' if table['current_match'] else 'bg-green-500/20 text-green-400' }}">
                    {{ 'BUSY' if table['current_match'] else 'FREE' }}
                </span>
            </div>

            <!-- Current Match -->
            {% if table['current_match'] %}
            <div class="mb-6 p-4 bg-pink-500/10 border border-pink-500/30 rounded-xl">
                <div class="text-xs text-pink-400 uppercase font-bold mb-2">ðŸŽ¯ Currently Playing</div>
                <div class="flex justify-between items-center">
                    <span class="font-bold text-lg">{{ table['current_match']['team1_name'] }}</span>
                    <span class="text-slate-500 text-sm">vs</span>
                    <span class="font-bold text-lg">{{ table['current_match']['team2_name'] }}</span>
                </div>
            </div>
            {% endif %}

            <!-- Match Queue -->
            <div class="space-y-3">
                <div class="text-xs text-slate-400 uppercase font-bold">Match Queue</div>
                {% if table['match_queue'] and table['match_queue']|length > 0 %}
                {% for match in table['match_queue'] %}
                <div class="flex justify-between items-center bg-slate-800/30 p-3 rounded-lg border border-slate-700/50 
                                {{ 'border-pink-500/50 bg-pink-500/5' if match['status'] == 'active' else '' }}">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <a href="{{ url_for('views.team_profile', team_id=match['team1_id']) }}"
                                class="font-semibold hover:text-pink-400 transition">{{ match['team1_name'] }}</a>
                            <span class="text-slate-500 text-xs">vs</span>
                            <a href="{{ url_for('views.team_profile', team_id=match['team2_id']) }}"
                                class="font-semibold hover:text-pink-400 transition">{{ match['team2_name'] }}</a>
                        </div>
                        {% if match['scheduled_start'] %}
                        <div class="text-xs text-slate-500">
                            {% if match['status'] == 'active' %}
                            Playing now
                            {% else %}
                            Starts: <span class="scheduled-time" data-time="{{ match['scheduled_start'] }}">{{
                                match['scheduled_start'] }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <div
                        class="text-xs font-bold px-2 py-1 rounded
                                    {{ 'bg-pink-500/20 text-pink-400' if match['status'] == 'active' else 'bg-slate-700 text-slate-300' }}">
                        {{ 'PLAYING' if match['status'] == 'active' else 'WAITING' }}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="py-8 text-center text-slate-500 italic">
                    No matches scheduled
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="mt-12 text-center">
        <a href="{{ url_for('views.index') }}"
            class="inline-block px-6 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition">Back to Home</a>
    </div>
</div>

<script>
    // Auto-refresh schedule every 3 seconds
    setInterval(async () => {
        try {
            const response = await fetch('/schedule');
            const html = await response.text();

            // Parse the new HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newSchedule = doc.getElementById('schedule-container');

            if (newSchedule) {
                document.getElementById('schedule-container').innerHTML = newSchedule.innerHTML;
                formatScheduledTimes();
            }
        } catch (error) {
            console.error('Error refreshing schedule:', error);
        }
    }, 3000);

    // Format scheduled times to be more human-readable
    function formatScheduledTimes() {
        document.querySelectorAll('.scheduled-time').forEach(el => {
            const timeStr = el.dataset.time;
            if (timeStr) {
                const time = new Date(timeStr.replace(' ', 'T'));
                el.textContent = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
        });
    }

    // Format times on initial load
    formatScheduledTimes();
</script>
{% endblock %}